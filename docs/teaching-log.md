# AI-UI é¡¹ç›®æ•™å­¦æ—¥å¿—

## æ¦‚è¿°

è¿™ä¸ªæ–‡æ¡£è®°å½•äº† AI-UI æœ€å°åŒ–å­¦ä¹ é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„éœ€æ±‚å˜æ›´ã€æŠ€æœ¯æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆã€‚æ¯ä¸ªæ¡ç›®éƒ½ä»¥æ•™å­¦çš„æ–¹å¼è¯¦ç»†è¯´æ˜äº†é—®é¢˜åˆ†æã€æŠ€æœ¯é€‰æ‹©å’Œå®ç°æ­¥éª¤ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£ç°ä»£ AI åº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µã€‚

---

## ç¬¬ä¸€æ¬¡éœ€æ±‚å˜æ›´ï¼šå®ç°æµå¼å“åº”

### ğŸ“… æ—¶é—´
2025å¹´1æœˆ22æ—¥

### ğŸ¯ ç”¨æˆ·éœ€æ±‚
ç”¨æˆ·å¸Œæœ›å°†åŸæœ¬çš„åŒæ­¥èŠå¤©å“åº”æ”¹ä¸ºæµå¼å“åº”ï¼Œä»¥æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿå®æ—¶çœ‹åˆ° AI çš„å›å¤è¿‡ç¨‹ã€‚

### ğŸ¤” é—®é¢˜åˆ†æ

#### 1. AIèŠå¤©åº”ç”¨çš„æ ¸å¿ƒæ¶æ„ç†è§£
åœ¨AIèŠå¤©åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç†è§£ä¸åŒç»„ä»¶çš„èŒè´£ï¼š
- **èŠå¤©å¤„ç†å‡½æ•°**ï¼šè´Ÿè´£å¤„ç†ç”¨æˆ·æ¶ˆæ¯å¹¶ç”ŸæˆAIå“åº”
- **å·¥ä½œæµç®¡ç†**ï¼šä½¿ç”¨LangGraphåè°ƒæ•´ä¸ªå¯¹è¯æµç¨‹
- **AIæ¨¡å‹æ¥å£**ï¼šæŠ½è±¡ä¸åŒAIæä¾›å•†çš„è°ƒç”¨æ–¹å¼

#### 2. AIèŠå¤©åº”ç”¨çš„ç”¨æˆ·ä½“éªŒæŒ‘æˆ˜
- **åŸå§‹æ¶æ„**ï¼šåŒæ­¥è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…å®Œæ•´çš„AIå“åº”
- **ç›®æ ‡æ¶æ„**ï¼šæµå¼å“åº”ï¼Œç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ°AIå›å¤çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œæå‡èŠå¤©ä½“éªŒ
- **æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•åœ¨FastAPIåç«¯å®ç°Server-Sent Events (SSE)æ¥æ”¯æŒAIæµå¼å“åº”

### ğŸ’¡ è§£å†³æ–¹æ¡ˆè®¾è®¡

#### æŠ€æœ¯é€‰æ‹©ï¼šServer-Sent Events (SSE) ç”¨äºAIæµå¼å“åº”
**ä¸ºä»€ä¹ˆåœ¨AIèŠå¤©åº”ç”¨ä¸­é€‰æ‹©SSEè€Œä¸æ˜¯WebSocketï¼Ÿ**

1. **SSEåœ¨AIåº”ç”¨ä¸­çš„ä¼˜åŠ¿**ï¼š
   - å•å‘æ•°æ®æµï¼Œå®Œç¾åŒ¹é…AIæ¨¡å‹ç”Ÿæˆå“åº”çš„åœºæ™¯
   - è‡ªåŠ¨é‡è¿æœºåˆ¶ï¼Œæå‡AIèŠå¤©çš„ç¨³å®šæ€§
   - æ›´ç®€å•çš„å®ç°å’Œè°ƒè¯•ï¼Œé™ä½AIåº”ç”¨å¼€å‘å¤æ‚åº¦
   - åŸºäºHTTPï¼Œåœ¨ä¼ä¸šç¯å¢ƒä¸­éƒ¨ç½²AIåº”ç”¨æ›´å‹å¥½

2. **WebSocketåœ¨AIèŠå¤©åœºæ™¯çš„å±€é™**ï¼š
   - åŒå‘é€šä¿¡å¯¹äºAIå•å‘å“åº”ç”Ÿæˆæ¥è¯´è¿‡äºå¤æ‚
   - è¿æ¥ç®¡ç†å¢åŠ äº†AIåº”ç”¨çš„å¤æ‚åº¦
   - å¯¹äºå¤§å¤šæ•°AIèŠå¤©åœºæ™¯æ¥è¯´å®ç°æˆæœ¬è¿‡é«˜

#### AIèŠå¤©åº”ç”¨çš„æµå¼å“åº”æ¶æ„
```
Reactå‰ç«¯ â†’ FastAPIè·¯ç”± â†’ LangGraphå·¥ä½œæµ â†’ AIæ¨¡å‹(Moonshot/OpenAI) â†’ SSEæµå¼å“åº”
    â”‚              â”‚              â”‚                    â”‚                      â”‚
    â”œâ”€ ç”¨æˆ·è¾“å…¥ â”€â”€â”€â”€â”€â”€â”¤              â”‚                    â”‚                      â”‚
    â”‚              â”œâ”€ è¯·æ±‚éªŒè¯ â”€â”€â”€â”€â”€â”¤                    â”‚                      â”‚
    â”‚              â”‚              â”œâ”€ æ¶ˆæ¯å¤„ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
    â”‚              â”‚              â”‚                    â”œâ”€ æµå¼ç”Ÿæˆ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”œâ”€ å®æ—¶æ˜¾ç¤º â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
```

### ğŸ”§ å®ç°æ­¥éª¤

#### æ­¥éª¤1ï¼šæ‰©å±•æ•°æ®æ¨¡å‹
**æ–‡ä»¶**ï¼š`backend/app/models/chat.py`

**æ–°å¢å†…å®¹**ï¼š
```python
class StreamChunk(BaseModel):
    """æµå¼å“åº”çš„æ•°æ®å—æ¨¡å‹"""
    type: str  # 'start', 'chunk', 'end', 'error'
    content: str
    conversation_id: str
    timestamp: datetime
    metadata: Optional[Dict[str, Any]] = None
```

**è®¾è®¡æ€è·¯**ï¼š
- ä½¿ç”¨ `type` å­—æ®µåŒºåˆ†ä¸åŒç±»å‹çš„æ•°æ®å—
- `start`: å¼€å§‹ä¿¡å·
- `chunk`: å†…å®¹å—
- `end`: ç»“æŸä¿¡å·ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯ï¼‰
- `error`: é”™è¯¯ä¿¡å·

#### æ­¥éª¤2ï¼šæ‰©å±•AIæ¨¡å‹æ¥å£
**æ–‡ä»¶**ï¼š`backend/app/chat/ai_models.py`

**å…³é”®å˜æ›´**ï¼š
```python
@abstractmethod
async def generate_response_stream(self, 
                                 messages: List[BaseMessage], 
                                 **kwargs) -> AsyncGenerator[str, None]:
    """ç”Ÿæˆæµå¼AIå“åº”"""
    pass
```

**AIæ¨¡å‹æ¥å£è®¾è®¡è¦ç‚¹**ï¼š
- ä½¿ç”¨ `AsyncGenerator` å®ç°å¼‚æ­¥ç”Ÿæˆå™¨ï¼Œæ”¯æŒAIæ¨¡å‹çš„æµå¼è¾“å‡º
- æŠ½è±¡ä¸åŒAIæä¾›å•†(Moonshotã€OpenAIã€Ollama)çš„æµå¼æ¥å£
- æ¨¡æ‹Ÿå®ç°ä¸­æŒ‰å•è¯åˆ†å‰²å¹¶æ·»åŠ å»¶è¿Ÿï¼Œæ¨¡æ‹ŸçœŸå®AIæ¨¡å‹çš„æµå¼å“åº”è¡Œä¸º

#### æ­¥éª¤3ï¼šæ‰©å±•å·¥ä½œæµ
**æ–‡ä»¶**ï¼š`backend/app/chat/workflow.py`

**æ–°å¢æ–¹æ³•**ï¼š
```python
async def process_message_stream(self, request: ChatRequest) -> AsyncGenerator[StreamChunk, None]:
    """å¤„ç†æµå¼èŠå¤©è¯·æ±‚"""
    # å‘é€å¼€å§‹ä¿¡å·
    yield StreamChunk(type="start", ...)
    
    # æµå¼ç”Ÿæˆå†…å®¹
    async for chunk in self.ai_model.generate_response_stream(messages):
        yield StreamChunk(type="chunk", content=chunk, ...)
    
    # å‘é€ç»“æŸä¿¡å·
    yield StreamChunk(type="end", ...)
```

**LangGraphå·¥ä½œæµè®¾è®¡äº®ç‚¹**ï¼š
- ä¿æŒåŸæœ‰åŒæ­¥èŠå¤©æ¥å£ä¸å˜ï¼Œæ–°å¢AIæµå¼å“åº”æ¥å£
- ç»Ÿä¸€çš„AIæ¨¡å‹é”™è¯¯å¤„ç†æœºåˆ¶
- å®Œæ•´çš„AIå¯¹è¯ä¼šè¯ç®¡ç†å’Œä¸Šä¸‹æ–‡ç»´æŠ¤

#### æ­¥éª¤4ï¼šå®ç°SSEè·¯ç”±
**æ–‡ä»¶**ï¼š`backend/app/routes/chat.py`

**æ ¸å¿ƒå®ç°**ï¼š
```python
@router.post("/stream")
async def chat_stream(request: ChatRequest, http_request: Request):
    async def generate_sse():
        async for chunk in chat_workflow.process_message_stream(request):
            chunk_data = chunk.model_dump()
            yield f"data: {json.dumps(chunk_data, ensure_ascii=False)}\n\n"
    
    return StreamingResponse(
        generate_sse(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "Access-Control-Allow-Origin": "*"
        }
    )
```

**AIæµå¼å“åº”çš„æŠ€æœ¯ç»†èŠ‚**ï¼š
- ä½¿ç”¨FastAPIçš„ `StreamingResponse` å®ç°AIå†…å®¹çš„SSEä¼ è¾“
- æ­£ç¡®çš„SSEæ ¼å¼ï¼š`data: {json}\n\n`ï¼Œç¡®ä¿å‰ç«¯èƒ½æ­£ç¡®è§£æAIå“åº”
- è®¾ç½®å¿…è¦çš„HTTPå¤´ï¼Œæ”¯æŒè·¨åŸŸAIåº”ç”¨è®¿é—®

### ğŸ“ å…³é”®å­¦ä¹ ç‚¹

#### 1. AIæµå¼å“åº”ä¸­çš„å¼‚æ­¥ç”Ÿæˆå™¨
```python
async def generate_ai_response():
    # æ¨¡æ‹ŸAIæ¨¡å‹çš„æµå¼ç”Ÿæˆè¿‡ç¨‹
    ai_response = "è¿™æ˜¯ä¸€ä¸ªAIç”Ÿæˆçš„å›å¤ç¤ºä¾‹"
    for word in ai_response.split():
        await asyncio.sleep(0.1)  # æ¨¡æ‹ŸAIæ¨¡å‹çš„ç”Ÿæˆå»¶è¿Ÿ
        yield word + " "

# åœ¨AIèŠå¤©åº”ç”¨ä¸­çš„ä½¿ç”¨æ–¹å¼
async for chunk in generate_ai_response():
    # å®æ—¶å‘é€AIç”Ÿæˆçš„å†…å®¹å—åˆ°å‰ç«¯
    print(f"AIç”Ÿæˆ: {chunk}")
```

#### 2. AIèŠå¤©åº”ç”¨ä¸­çš„SSEåè®®æ ¼å¼
```
data: {"type": "start", "conversation_id": "chat_001"}\n\n
data: {"type": "chunk", "content": "ä½ å¥½ï¼Œ"}\n\n
data: {"type": "chunk", "content": "æˆ‘æ˜¯AIåŠ©æ‰‹"}\n\n
data: {"type": "end", "total_tokens": 150}\n\n
```

#### 3. FastAPI StreamingResponseåœ¨AIåº”ç”¨ä¸­çš„ä½¿ç”¨
- ä¸“é—¨ç”¨äºè¿”å›AIæ¨¡å‹çš„æµå¼ç”Ÿæˆæ•°æ®
- éœ€è¦æ­£ç¡®è®¾ç½® `media_type="text/event-stream"` å’ŒCORSå¤´
- AIå“åº”ç”Ÿæˆå™¨å‡½æ•°å¿…é¡»æ˜¯å¼‚æ­¥çš„ï¼ŒåŒ¹é…AIæ¨¡å‹çš„å¼‚æ­¥ç‰¹æ€§

### ğŸ§ª æµ‹è¯•ç­–ç•¥

åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•è„šæœ¬ `backend/test_stream_chat.py`ï¼š

**AIæµå¼å“åº”æµ‹è¯•å†…å®¹**ï¼š
1. AIæµå¼ç«¯ç‚¹çš„è¿æ¥æ€§å’Œç¨³å®šæ€§
2. SSEæ•°æ®æ ¼å¼åœ¨AIå“åº”ä¸­çš„æ­£ç¡®æ€§
3. AIå“åº”ä¸åŒé˜¶æ®µ(start/chunk/end)çš„æ•°æ®å—å¤„ç†
4. AIæ¨¡å‹å¼‚å¸¸æƒ…å†µçš„é”™è¯¯å¤„ç†æœºåˆ¶

**AIåº”ç”¨æµ‹è¯•æŠ€å·§**ï¼š
- ä½¿ç”¨ `httpx.AsyncClient.stream()` æµ‹è¯•AIæµå¼å“åº”
- é€è¡Œè§£æAIç”Ÿæˆå†…å®¹çš„SSEæ•°æ®
- å¯¹æ¯”AIæµå¼å’Œéæµå¼å“åº”çš„å†…å®¹ä¸€è‡´æ€§

### ğŸ“ æœ€ä½³å®è·µæ€»ç»“

#### 1. AIèŠå¤©åº”ç”¨çš„å‘åå…¼å®¹æ€§
- ä¿ç•™åŸæœ‰çš„åŒæ­¥AIèŠå¤©æ¥å£ `/api/chat/`
- æ–°å¢AIæµå¼å“åº”æ¥å£ `/api/chat/stream`
- å‰ç«¯å¯ä»¥æ ¹æ®ç”¨æˆ·ä½“éªŒéœ€æ±‚é€‰æ‹©åŒæ­¥æˆ–æµå¼AIäº¤äº’æ–¹å¼

#### 2. AIåº”ç”¨çš„é”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„AIæ¨¡å‹é”™è¯¯å“åº”æ ¼å¼
- AIæµå¼ç”Ÿæˆè¿‡ç¨‹ä¸­çš„é”™è¯¯ä¹Ÿé€šè¿‡SSEä¼ é€’ç»™å‰ç«¯
- å®Œæ•´çš„AIäº¤äº’æ—¥å¿—è®°å½•ï¼Œä¾¿äºè°ƒè¯•å’Œç›‘æ§

#### 3. AIæµå¼å“åº”çš„æ€§èƒ½ä¼˜åŒ–
- åˆç†çš„AIå†…å®¹åˆ†å—å¤§å°ï¼ˆæŒ‰å•è¯æˆ–å¥å­åˆ†å‰²ï¼‰
- é€‚å½“çš„æµå¼å»¶è¿Ÿæ§åˆ¶ï¼Œå¹³è¡¡å“åº”é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒ
- AIå¯¹è¯ä¸Šä¸‹æ–‡çš„å†…å­˜ä½¿ç”¨ä¼˜åŒ–

#### 4. AIèŠå¤©çš„ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- æ¸…æ™°çš„AIå“åº”çŠ¶æ€æŒ‡ç¤ºï¼ˆå¼€å§‹ç”Ÿæˆ/å†…å®¹å—/ç”Ÿæˆå®Œæˆï¼‰
- ä¸°å¯Œçš„AIäº¤äº’å…ƒæ•°æ®ï¼ˆtokenä½¿ç”¨é‡ã€å“åº”æ—¶é—´ç­‰ï¼‰
- AIå¤„ç†æ—¶é—´ç»Ÿè®¡ï¼Œå¸®åŠ©ç”¨æˆ·äº†è§£AIå“åº”æ€§èƒ½

### ğŸ”® AIèŠå¤©åº”ç”¨çš„åç»­ä¼˜åŒ–æ–¹å‘

1. **Reactå‰ç«¯é›†æˆ**ï¼šå®ç°å‰ç«¯çš„SSEå®¢æˆ·ç«¯ï¼Œå®Œå–„AIèŠå¤©ç•Œé¢
2. **çœŸå®AIæ¨¡å‹é›†æˆ**ï¼šé›†æˆMoonshotã€OpenAIç­‰çœŸå®AIæ¨¡å‹çš„æµå¼API
3. **AIå“åº”ä¼˜åŒ–**ï¼šå®ç°æ›´æ™ºèƒ½çš„AIå†…å®¹åˆ†å—å’Œç¼“å­˜ç­–ç•¥
4. **AIåº”ç”¨ç›‘æ§**ï¼šæ·»åŠ AIæ¨¡å‹è°ƒç”¨ã€å“åº”æ—¶é—´ã€tokenä½¿ç”¨çš„ç›‘æ§æŒ‡æ ‡

---

---

*ä¸‹ä¸€ä¸ªéœ€æ±‚å˜æ›´å°†ç»§ç»­è®°å½•åœ¨æ­¤æ–‡æ¡£ä¸­...*