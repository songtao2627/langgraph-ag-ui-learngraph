# AI-UI é¡¹ç›®æ•™å­¦æ—¥å¿—

## æ¦‚è¿°

è¿™ä¸ªæ–‡æ¡£è®°å½•äº† AI-UI æœ€å°åŒ–å­¦ä¹ é¡¹ç›®çš„å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„éœ€æ±‚å˜æ›´ã€æŠ€æœ¯æŒ‘æˆ˜å’Œè§£å†³æ–¹æ¡ˆã€‚æ¯ä¸ªæ¡ç›®éƒ½ä»¥æ•™å­¦çš„æ–¹å¼è¯¦ç»†è¯´æ˜äº†é—®é¢˜åˆ†æã€æŠ€æœ¯é€‰æ‹©å’Œå®ç°æ­¥éª¤ï¼Œå¸®åŠ©å¼€å‘è€…ç†è§£ç°ä»£ AI åº”ç”¨å¼€å‘çš„æœ€ä½³å®è·µã€‚

---

## ç¬¬ä¸€æ¬¡éœ€æ±‚å˜æ›´ï¼šå®ç°æµå¼å“åº”

### ğŸ“… æ—¶é—´
2025å¹´1æœˆ22æ—¥

### ğŸ¯ ç”¨æˆ·éœ€æ±‚
ç”¨æˆ·å¸Œæœ›å°†åŸæœ¬çš„åŒæ­¥èŠå¤©å“åº”æ”¹ä¸ºæµå¼å“åº”ï¼Œä»¥æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè®©ç”¨æˆ·èƒ½å¤Ÿå®æ—¶çœ‹åˆ° AI çš„å›å¤è¿‡ç¨‹ã€‚

### ğŸ¤” é—®é¢˜åˆ†æ

#### 1. æœ¯è¯­æ¾„æ¸…
**é—®é¢˜**ï¼šç”¨æˆ·è¯¢é—® `chat` åº”è¯¥å«å‡½æ•°è¿˜æ˜¯æ–¹æ³•ï¼Ÿ

**è§£ç­”**ï¼š
- **å‡½æ•°ï¼ˆFunctionï¼‰**ï¼šç‹¬ç«‹å­˜åœ¨çš„å¯è°ƒç”¨ä»£ç å—
- **æ–¹æ³•ï¼ˆMethodï¼‰**ï¼šå±äºç±»çš„å‡½æ•°

åœ¨æˆ‘ä»¬çš„åœºæ™¯ä¸­ï¼Œ`chat` æ˜¯ä¸€ä¸ªç‹¬ç«‹çš„å¼‚æ­¥å‡½æ•°ï¼Œä¸å±äºä»»ä½•ç±»ï¼Œæ‰€ä»¥åº”è¯¥å«**å‡½æ•°**ã€‚

#### 2. æŠ€æœ¯æŒ‘æˆ˜åˆ†æ
- **åŸå§‹æ¶æ„**ï¼šåŒæ­¥è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œç”¨æˆ·éœ€è¦ç­‰å¾…å®Œæ•´å“åº”
- **ç›®æ ‡æ¶æ„**ï¼šæµå¼å“åº”ï¼Œç”¨æˆ·å¯ä»¥å®æ—¶çœ‹åˆ° AI å›å¤çš„ç”Ÿæˆè¿‡ç¨‹
- **æ ¸å¿ƒé—®é¢˜**ï¼šå¦‚ä½•åœ¨ FastAPI ä¸­å®ç° Server-Sent Events (SSE)

### ğŸ’¡ è§£å†³æ–¹æ¡ˆè®¾è®¡

#### æŠ€æœ¯é€‰æ‹©ï¼šServer-Sent Events (SSE)
**ä¸ºä»€ä¹ˆé€‰æ‹© SSE è€Œä¸æ˜¯ WebSocketï¼Ÿ**

1. **SSE ä¼˜åŠ¿**ï¼š
   - å•å‘æ•°æ®æµï¼Œé€‚åˆ AI å“åº”åœºæ™¯
   - è‡ªåŠ¨é‡è¿æœºåˆ¶
   - æ›´ç®€å•çš„å®ç°å’Œè°ƒè¯•
   - åŸºäº HTTPï¼Œé˜²ç«å¢™å‹å¥½

2. **WebSocket å¯¹æ¯”**ï¼š
   - åŒå‘é€šä¿¡ï¼Œå¯¹äºå•å‘ AI å“åº”æ¥è¯´è¿‡äºå¤æ‚
   - éœ€è¦å¤„ç†è¿æ¥ç®¡ç†
   - å®ç°å¤æ‚åº¦æ›´é«˜

#### æ¶æ„è®¾è®¡
```
ç”¨æˆ·è¯·æ±‚ â†’ FastAPIè·¯ç”± â†’ å·¥ä½œæµå¤„ç† â†’ AIæ¨¡å‹æµå¼ç”Ÿæˆ â†’ SSEå“åº”æµ
```

### ğŸ”§ å®ç°æ­¥éª¤

#### æ­¥éª¤1ï¼šæ‰©å±•æ•°æ®æ¨¡å‹
**æ–‡ä»¶**ï¼š`backend/app/models/chat.py`

**æ–°å¢å†…å®¹**ï¼š
```python
class StreamChunk(BaseModel):
    """æµå¼å“åº”çš„æ•°æ®å—æ¨¡å‹"""
    type: str  # 'start', 'chunk', 'end', 'error'
    content: str
    conversation_id: str
    timestamp: datetime
    metadata: Optional[Dict[str, Any]] = None
```

**è®¾è®¡æ€è·¯**ï¼š
- ä½¿ç”¨ `type` å­—æ®µåŒºåˆ†ä¸åŒç±»å‹çš„æ•°æ®å—
- `start`: å¼€å§‹ä¿¡å·
- `chunk`: å†…å®¹å—
- `end`: ç»“æŸä¿¡å·ï¼ˆåŒ…å«ç»Ÿè®¡ä¿¡æ¯ï¼‰
- `error`: é”™è¯¯ä¿¡å·

#### æ­¥éª¤2ï¼šæ‰©å±•AIæ¨¡å‹æ¥å£
**æ–‡ä»¶**ï¼š`backend/app/chat/ai_models.py`

**å…³é”®å˜æ›´**ï¼š
```python
@abstractmethod
async def generate_response_stream(self, 
                                 messages: List[BaseMessage], 
                                 **kwargs) -> AsyncGenerator[str, None]:
    """ç”Ÿæˆæµå¼AIå“åº”"""
    pass
```

**å®ç°è¦ç‚¹**ï¼š
- ä½¿ç”¨ `AsyncGenerator` å®ç°å¼‚æ­¥ç”Ÿæˆå™¨
- æ¨¡æ‹Ÿå®ç°ä¸­æŒ‰å•è¯åˆ†å‰²å¹¶æ·»åŠ å»¶è¿Ÿï¼Œæ¨¡æ‹ŸçœŸå®çš„æµå¼å“åº”

#### æ­¥éª¤3ï¼šæ‰©å±•å·¥ä½œæµ
**æ–‡ä»¶**ï¼š`backend/app/chat/workflow.py`

**æ–°å¢æ–¹æ³•**ï¼š
```python
async def process_message_stream(self, request: ChatRequest) -> AsyncGenerator[StreamChunk, None]:
    """å¤„ç†æµå¼èŠå¤©è¯·æ±‚"""
    # å‘é€å¼€å§‹ä¿¡å·
    yield StreamChunk(type="start", ...)
    
    # æµå¼ç”Ÿæˆå†…å®¹
    async for chunk in self.ai_model.generate_response_stream(messages):
        yield StreamChunk(type="chunk", content=chunk, ...)
    
    # å‘é€ç»“æŸä¿¡å·
    yield StreamChunk(type="end", ...)
```

**è®¾è®¡äº®ç‚¹**ï¼š
- ä¿æŒåŸæœ‰åŒæ­¥æ¥å£ä¸å˜ï¼Œæ–°å¢æµå¼æ¥å£
- ç»Ÿä¸€çš„é”™è¯¯å¤„ç†æœºåˆ¶
- å®Œæ•´çš„ä¼šè¯ç®¡ç†

#### æ­¥éª¤4ï¼šå®ç°SSEè·¯ç”±
**æ–‡ä»¶**ï¼š`backend/app/routes/chat.py`

**æ ¸å¿ƒå®ç°**ï¼š
```python
@router.post("/stream")
async def chat_stream(request: ChatRequest, http_request: Request):
    async def generate_sse():
        async for chunk in chat_workflow.process_message_stream(request):
            chunk_data = chunk.model_dump()
            yield f"data: {json.dumps(chunk_data, ensure_ascii=False)}\n\n"
    
    return StreamingResponse(
        generate_sse(),
        media_type="text/event-stream",
        headers={
            "Cache-Control": "no-cache",
            "Connection": "keep-alive",
            "Access-Control-Allow-Origin": "*"
        }
    )
```

**æŠ€æœ¯ç»†èŠ‚**ï¼š
- ä½¿ç”¨ `StreamingResponse` å®ç° SSE
- æ­£ç¡®çš„ SSE æ ¼å¼ï¼š`data: {json}\n\n`
- å¿…è¦çš„ HTTP å¤´è®¾ç½®

### ğŸ“ å…³é”®å­¦ä¹ ç‚¹

#### 1. å¼‚æ­¥ç”Ÿæˆå™¨çš„ä½¿ç”¨
```python
async def generate_data():
    for i in range(10):
        await asyncio.sleep(0.1)  # æ¨¡æ‹Ÿå¼‚æ­¥æ“ä½œ
        yield f"data_{i}"

# ä½¿ç”¨æ–¹å¼
async for item in generate_data():
    print(item)
```

#### 2. SSE åè®®æ ¼å¼
```
data: {"type": "chunk", "content": "Hello"}\n\n
data: {"type": "chunk", "content": " World"}\n\n
data: {"type": "end"}\n\n
```

#### 3. FastAPI StreamingResponse
- ç”¨äºè¿”å›æµå¼æ•°æ®
- éœ€è¦æ­£ç¡®è®¾ç½® `media_type` å’Œ `headers`
- ç”Ÿæˆå™¨å‡½æ•°å¿…é¡»æ˜¯å¼‚æ­¥çš„

### ğŸ§ª æµ‹è¯•ç­–ç•¥

åˆ›å»ºäº†ä¸“é—¨çš„æµ‹è¯•è„šæœ¬ `backend/test_stream_chat.py`ï¼š

**æµ‹è¯•å†…å®¹**ï¼š
1. æµå¼ç«¯ç‚¹çš„è¿æ¥æ€§
2. SSE æ•°æ®æ ¼å¼çš„æ­£ç¡®æ€§
3. ä¸åŒç±»å‹æ•°æ®å—çš„å¤„ç†
4. é”™è¯¯å¤„ç†æœºåˆ¶

**æµ‹è¯•æŠ€å·§**ï¼š
- ä½¿ç”¨ `httpx.AsyncClient.stream()` æµ‹è¯• SSE
- é€è¡Œè§£æ SSE æ•°æ®
- å¯¹æ¯”æµå¼å’Œéæµå¼å“åº”çš„ä¸€è‡´æ€§

### ğŸ“ æœ€ä½³å®è·µæ€»ç»“

#### 1. å‘åå…¼å®¹æ€§
- ä¿ç•™åŸæœ‰çš„åŒæ­¥æ¥å£ `/api/chat/`
- æ–°å¢æµå¼æ¥å£ `/api/chat/stream`
- å®¢æˆ·ç«¯å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©ä½¿ç”¨å“ªç§æ¥å£

#### 2. é”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„é”™è¯¯æ ¼å¼
- æµå¼è¿‡ç¨‹ä¸­çš„é”™è¯¯ä¹Ÿé€šè¿‡ SSE ä¼ é€’
- å®Œæ•´çš„æ—¥å¿—è®°å½•

#### 3. æ€§èƒ½è€ƒè™‘
- åˆç†çš„å—å¤§å°ï¼ˆæŒ‰å•è¯åˆ†å‰²ï¼‰
- é€‚å½“çš„å»¶è¿Ÿæ§åˆ¶
- å†…å­˜ä½¿ç”¨ä¼˜åŒ–

#### 4. ç”¨æˆ·ä½“éªŒ
- æ¸…æ™°çš„çŠ¶æ€æŒ‡ç¤ºï¼ˆstart/chunk/endï¼‰
- ä¸°å¯Œçš„å…ƒæ•°æ®ä¿¡æ¯
- å¤„ç†æ—¶é—´ç»Ÿè®¡

### ğŸ”® åç»­ä¼˜åŒ–æ–¹å‘

1. **å‰ç«¯é›†æˆ**ï¼šå®ç°å‰ç«¯çš„ SSE å®¢æˆ·ç«¯
2. **çœŸå®AIæ¨¡å‹**ï¼šé›†æˆçœŸå®çš„æµå¼AIæ¨¡å‹ï¼ˆå¦‚ OpenAI çš„æµå¼APIï¼‰
3. **æ€§èƒ½ä¼˜åŒ–**ï¼šå®ç°æ›´æ™ºèƒ½çš„åˆ†å—ç­–ç•¥
4. **ç›‘æ§æŒ‡æ ‡**ï¼šæ·»åŠ æµå¼å“åº”çš„æ€§èƒ½ç›‘æ§

---

*ä¸‹ä¸€ä¸ªéœ€æ±‚å˜æ›´å°†ç»§ç»­è®°å½•åœ¨æ­¤æ–‡æ¡£ä¸­...*